# 二、数据库基本表定义

数据库包含7个实体，14张表，使用`sql`语句进行数据库初始化，并将数据库迁移到`django.models`中，每个表对应一个模型类，类中的属性对应对应表中的列。

具体定义以及实现代码见下：

## 用户部分

由于我们的题目中存在多种用户，因此我采用了父类-子类的架构，由`User`表作为父类，`Doctor`和`Patient`作为子类，通过`User.type`进行判断，而管理员表中并无多余信息，因此我并没有针对管理员建表。

表的属性见下。

### 2.0 User(用户表)

| 属性     | 中文   | 类型        | 备注           |
| -------- | ------ | ----------- | -------------- |
| id       | 编号   | VARCHAR(25) | NOT NULL，主码 |
| username | 用户名 | VarCHAR(25) | NOT NULL       |
| password | 密码   | VarCHAR(25) | NOT NULL       |
| type     | 类型   | VarCHAR(25) | NOT NULL       |

```python
class User(models.Model):
    id = models.CharField(primary_key=True, max_length=25)
    username = models.CharField(db_column='USERNAME', max_length=25)  # Field name made lowercase.
    password = models.CharField(max_length=25)
    type = models.CharField(max_length=25)

    class Meta:
        managed = False
        db_table = 'user'
```

### 2.1 Patient(病人表)继承User

| 属性     | 中文           | 类型        | 备注           |
| -------- | -------------- | ----------- | -------------- |
| id       | 用户名         | VARCHAR(25) | NOT NULL，外码 |
| isComMem | 是否为社区成员 | BOOLEAN     | NOT NULL       |
| active   | 是否被删除     | BOOLEAN     | NOT NULL       |
| idCard   | 身份证号       | VarCHAR(25) |                |

```py
class Patient(models.Model):
    id = models.CharField(primary_key=True, max_length=25)
    iscommem = models.IntegerField(db_column='isComMem')  # Field name made lowercase.
    idcard = models.CharField(db_column='idCard', max_length=25, blank=True, null=True)  # Field name made lowercase.
    active = models.IntegerField()

    class Meta:
        managed = False
        db_table = 'patient'
```



### 2.2 Doctor(医生表)继承User

| 属性   | 中文         | 类型        | 备注                   |
| ------ | ------------ | ----------- | ---------------------- |
| id     | 医生编号     | VARCHAR(25) | NOT NULL，外码继承User |
| active | 是否活跃     | BOOLEAN     | NOT NULL               |
| Tid    | 负责科室编号 | VarCHAR(25) | NOT NULL               |

```py
class Doctor(models.Model):
    id = models.CharField(primary_key=True, max_length=25)
    tid = models.ForeignKey('Titles', models.DO_NOTHING, db_column='Tid')  # Field name made lowercase.
    active = models.IntegerField()

    class Meta:
        managed = False
        db_table = 'doctor'
```

## 医院实体

医院实体主要包括了科室，药品，诊室和检查项目四种不同的实体。基本实现见下

### 2.3 Title(科室表)

| 属性 | 中文 | 类型        | 备注          |
| ---- | ---- | ----------- | ------------- |
| id   | 编号 | VARCHAR(25) | NOT NULL,主码 |
| name | 名称 | VARCHAR(25) | NOT NULL      |

```python
class Titles(models.Model):
    id = models.CharField(primary_key=True, max_length=25)
    name = models.CharField(max_length=25)

    class Meta:
        managed = False
        db_table = 'titles'
```



### 2.4 Drug(药品表)

| 属性        | 中文       | 类型        | 备注           |
| ----------- | ---------- | ----------- | -------------- |
| id          | 药品编号   | VARCHAR(25) | NOT NULL，主码 |
| isBanned    | 是否被禁止 | BOOLEAN     | NOT NULL       |
| price       | 药品价格   | FLOAT       | NOT NULL       |
| Storage     | 存储量     | FLOAT       | NOT NULL       |
| description | 药品描述   | TEXT        | NOT NULL       |

```python
class Drug(models.Model):
    id = models.CharField(primary_key=True, max_length=25)
    name = models.CharField(max_length=25)
    price = models.FloatField()
    description = models.TextField(db_column='Description')  # Field name made lowercase.
    isbanned = models.IntegerField(db_column='isBanned')  # Field name made lowercase.
    storage = models.FloatField(db_column='Storage')  # Field name made lowercase.

    class Meta:
        managed = False
        db_table = 'drug'
```

### 2.5 ROOM(诊室表)

| 属性       | 中文       | 类型        | 备注           |
| ---------- | ---------- | ----------- | -------------- |
| id         | 诊室编号   | VARCHAR(25) | NOT NULL，主码 |
| isOccupied | 是否被占用 | BOOLEAN     | NOT NULL       |
| QueueLen   | 排队人数   | int         | NOT NULL       |

```python
class Room(models.Model):
    id = models.CharField(primary_key=True, max_length=25)
    isoccupied = models.IntegerField(db_column='isOccupied')  # Field name made lowercase.
    queuelen = models.IntegerField(db_column='QueueLen')  # Field name made lowercase.

    class Meta:
        managed = False
        db_table = 'room'
```



### 2.6 checkItems(检查项目)

| 属性        | 中文         | 类型         | 备注           |
| ----------- | ------------ | ------------ | -------------- |
| id          | 检查项目编号 | VARCHAR(25)  | NOT NULL，主码 |
| price       | 检查项目价格 | FLOAT        | NOT NULL       |
| description | 检擦项目描述 | VARCHAR(255) | NOT NULL       |
| MinResult   | 最小值       | FLOAT        | NOT NULL       |
| MaxResult   | 最大值       | FLOAT        | NOT NULL       |

```python
class Checkitems(models.Model):
    id = models.CharField(primary_key=True, max_length=25)
    price = models.FloatField()
    description = models.CharField(max_length=255)
    minresult = models.FloatField(db_column='MinResult')  # Field name made lowercase.
    maxresult = models.FloatField(db_column='MaxResult')  # Field name made lowercase.

    class Meta:
        managed = False
        db_table = 'checkitems'
```

## 关系表

关系表主要分为以下几类：

1. 付费订单

   包括了

   1. 挂号
   2. 开药
   3. 化验

2. 免费订单，目前只支持诊断结果

3. 排班关系，展示医生排班情况。

对于付费订单类，我们使用了`Counter`作为基本表，以其为基础，用`RegistRelation`,`MedicinePurchase`,`LaboratoryShee`三个表来对其进行继承，使用了`Counter.id`作为外码，保持父子表的关系。

### 2.7 Counter(订单表)

| 属性   | 中文       | 类型        | 备注                      |
| ------ | ---------- | ----------- | ------------------------- |
| id     | 订单编号   | VARCHAR(25) | NOT NULL, 主码            |
| isPaid | 是否已支付 | BOOLEAN     | NOT NULL                  |
| price  | 价格       | FLOAT       | NOT NULL                  |
| Pid    | 病人编号   | VARCHAR(25) | NOT NULL，外码继承Patient |
| Did    | 医生编号   | VARCHAR(25) | NOT NULL,外码继承DOCTOR   |
| DATE   | 日期       | DATE        | NOT NULL                  |
| type   | 订单种类   | VARCHAR(25) | NOT NULL                  |

```python
class Counter(models.Model):
    id = models.CharField(primary_key=True, max_length=25)
    pid = models.ForeignKey('Patient', models.DO_NOTHING, db_column='Pid')  # Field name made lowercase.
    did = models.ForeignKey('Doctor', models.DO_NOTHING, db_column='Did')  # Field name made lowercase.
    ispaid = models.IntegerField(db_column='isPaid')  # Field name made lowercase.
    price = models.FloatField(blank=True, null=True)
    date = models.DateField(db_column='DATE')  # Field name made lowercase.
    type = models.CharField(max_length=25)

    class Meta:
        managed = False
        db_table = 'counter'
```



### 2.8 RegistRelation(登记表(挂号)

| 属性       | 中文       | 类型        | 备注                                   |
| ---------- | ---------- | ----------- | -------------------------------------- |
| id         | 订单编号   | VARCHAR(25) | NOT NULL, PRIMARY KEY，外码继承Counter |
| ROOMID     | 诊室编号   | VARCHAR(25) | NOT NULL                               |
| isFinished | 是否被完成 | BOOLEAN     | NOT NULL                               |

```python
class Registrelation(models.Model):
    id = models.OneToOneField(Counter, models.DO_NOTHING, db_column='id', primary_key=True)
    roomid = models.CharField(db_column='ROOMID', max_length=25)  # Field name made lowercase.
    isfinished = models.IntegerField(db_column='isFinished')  # Field name made lowercase.

    class Meta:
        managed = False
        db_table = 'registrelation'
```



### 2.10 MedicinePurchase

| 属性   | 中文     | 类型        | 备注                   |
| ------ | -------- | ----------- | ---------------------- |
| id     | 订单编号 | VARCHAR(25) | NOT NULL,主码          |
| drugid | 药品编码 | VARCHAR(25) | NOT NULL，外码继承Drug |
| amount | 购买数量 | FLOAT       | NOT NULL               |

```python
class Medicinepurchase(models.Model):
    id = models.OneToOneField(Counter, models.DO_NOTHING, db_column='id', primary_key=True)  # The composite primary key (id, drugId) found, that is not supported. The first column is selected.
    drugid = models.ForeignKey(Drug, models.DO_NOTHING, db_column='drugId')  # Field name made lowercase.
    amount = models.FloatField()

    class Meta:
        managed = False
        db_table = 'medicinepurchase'
        unique_together = (('id', 'drugid'),)
```



### 2.11 LaboratorySheet(化验订单)

| 属性       | 中文         | 类型         | 备注           |
| ---------- | ------------ | ------------ | -------------- |
| id         | 订单编号     | VARCHAR(25)  | NOT NULL, 主码 |
| checkName  | 化验名称     | VARCHAR(25)  | NOT NULL       |
| beginTime  | 检查时间     | DATETIME     | NOT NULL       |
| OutputTime | 结果时间     | DATETIME     | NOT NULL       |
| itemId     | 检查项目编号 | VARCHAR(25)  | NOT NULL,主码  |
| result     | 检查结果     | VARCHAR(255) | NOT NULL       |

```python
class Laboratorysheet(models.Model):
    id = models.OneToOneField(Counter, models.DO_NOTHING, db_column='id', primary_key=True)  # The composite primary key (id, itemID) found, that is not supported. The first column is selected.
    checkname = models.CharField(db_column='checkName', max_length=255)  # Field name made lowercase.
    begintime = models.DateTimeField(db_column='beginTime')  # Field name made lowercase.
    outputtime = models.DateTimeField(db_column='OutputTime', blank=True, null=True)  # Field name made lowercase.
    itemid = models.ForeignKey(Checkitems, models.DO_NOTHING, db_column='itemID')  # Field name made lowercase.
    result = models.FloatField()

    class Meta:
        managed = False
        db_table = 'laboratorysheet'
        unique_together = (('id', 'itemid'),)
```

### 2.12 Dispatcher(医生排班调度器)

| 属性       | 中文                     | 类型        | 备注           |
| ---------- | ------------------------ | ----------- | -------------- |
| TimePeriod | 时间段                   | VARCHAR(25) | NOT NULL，主码 |
| ROOMID     | 诊室编号                 | VARCHAR(25) | NOT NULL，主码 |
| doctorId   | 医生编号                 | VARCHAR(25) |                |
| TitleId    | 负责的科室或活动名称编号 | VARCHAR(25) |                |
| DATE       | 日期（星期几）           | VARCHAR(15) | NOT NULL       |

```python
class Dispatcher(models.Model):
    timeperiod = models.CharField(db_column='TimePeriod', primary_key=True, max_length=25)  # Field name made lowercase. The composite primary key (TimePeriod, ROOMID, DATE) found, that is not supported. The first column is selected.
    roomid = models.ForeignKey('Room', models.DO_NOTHING, db_column='ROOMID')  # Field name made lowercase.
    doctorid = models.ForeignKey('Doctor', models.DO_NOTHING, db_column='doctorId', blank=True, null=True)  # Field name made lowercase.
    titleid = models.CharField(db_column='TitleId', max_length=25, blank=True, null=True)  # Field name made lowercase.
    date = models.CharField(db_column='DATE', max_length=15)  # Field name made lowercase.

    class Meta:
        managed = False
        db_table = 'dispatcher'
        unique_together = (('timeperiod', 'roomid', 'date'),)
```



### 2.13 diagnosis(诊断订单)

| 属性      | 中文     | 类型        | 备注          |
| --------- | -------- | ----------- | ------------- |
| id        | 订单编号 | VARCHAR(25) | NOT NULL,主码 |
| patientId | 病人编号 | VARCHAR(25) | NOT NULL      |
| doctorId  | 医生编号 | VARCHAR(25) | NOT NULL      |
| diagnosis | 诊断说明 | TEXT        | NOT NULL      |
| time      | 诊断时间 | DATETIME    | NOT NULL      |

```python
class Diagnosis(models.Model):
    id = models.CharField(primary_key=True, max_length=25)
    patientid = models.ForeignKey('Patient', models.DO_NOTHING, db_column='patientId')  # Field name made lowercase.
    doctorid = models.ForeignKey('Doctor', models.DO_NOTHING, db_column='doctorId')  # Field name made lowercase.
    diagnosis = models.TextField()
    time = models.DateTimeField()

    class Meta:
        managed = False
        db_table = 'diagnosis'
```



## 特殊实体表

对于检查项目，我们为了方便检查创建了常用检查组合表，方便医生直接进行检查。

### 2.14 CheckCombine(常用检查组合)

| 属性        | 中文       | 属性         | 备注                               |
| ----------- | ---------- | ------------ | ---------------------------------- |
| id          | 编号       | VARCHAR(25)  | NOT NULL,主码                      |
| itemId      | 检查项编号 | VARCHAR(25)  | NOT NULL，主码，外码继承checkItems |
| description | 名称       | VARCHAR(255) | NOT NULL                           |

```python
class Checkcombine(models.Model):
    id = models.CharField(primary_key=True, max_length=25)  # The composite primary key (id, itemId) found, that is not supported. The first column is selected.
    itemid = models.ForeignKey('Checkitems', models.DO_NOTHING, db_column='itemId')  # Field name made lowercase.
    checkname = models.CharField(db_column='checkName', max_length=255)  # Field name made lowercase.

    class Meta:
        managed = False
        db_table = 'checkcombine'
        unique_together = (('id', 'itemid'),)
```

# 四、系统实现效果

## 4.1公有界面

### 4.1.1系统首页

用户进入网站后会首先进入系统的首页，首页简单介绍了系统的功能，之后用户可以点击登录按钮进入系统登录界面。

![image-20231211191940784](https://alist.sanyue.site/d/imgbed/202312111922599.png)

### 4.1.2登录界面

用户登入系统的界面，医生、病人、管理员三方使用统一登录界面，可以使用用户名/用户编号和密码进行登录，如果没有输入某一项或者用户名密码错误，该界面会给出相应提示。

![image-20231211193800701](https://alist.sanyue.site/d/imgbed/202312111938645.png)

### 4.1.3注册界面

根据设计，注册界面目前仅支持**非社区用户注册**，由于系统中之前没有过这些用户的信息，因此需要他们在设置自己的用户名和密码的同时输入自己的身份证号进行身份的认证。

![image-20231211194257039](https://alist.sanyue.site/d/imgbed/202312111942939.png)

### 4.1.4主页

所有用户（医生、病人、管理员）进入系统后都会被路由到主页，这里会有进入系统的欢迎辞，同时还设置了**智能导医台功能**，通过调用ChatGpt接口，根据用户输入的自己的病情给用户提供一些建议，包括就诊科室等内容。

![image-20231211200950318](https://alist.sanyue.site/d/imgbed/202312112010295.png)

### 4.1.5个人中心

个人中心展示了用户的用户名、角色（医生、病人、管理员）等信息，同时提供了**退出登录**和**注销账号**操作。点击退出登录后会返回到系统登录页面，点击注销账号会出现警示弹窗，如果用户确认要注销账号，则成功注销后返回到系统的登录页面。

![image-20231211205759734](https://alist.sanyue.site/d/imgbed/202312112057918.png)

（确认注销账号弹窗）

![image-20231211211120985](https://alist.sanyue.site/d/imgbed/202312112111799.png)

 ## 4.2病人界面

### 4.2.1挂号预约界面

罗列了医院所有可以挂号地科室，病人可以结合智能导医台的建议和自己的实际情况选择需要就诊的科室，进入医生选择界面。

![image-20231211201201479](https://alist.sanyue.site/d/imgbed/202312112012774.png)

### 4.2.2医生选择界面

进入医生选择界面后，病人能够看到当前该科室所有可接诊的医生的有关信息（休息的医生不会显示），包含诊室编号、排队人数（含诊室队伍拥挤情况）等，病人可以根据有关信息预约对应的医生。

![image-20231211201436751](https://alist.sanyue.site/d/imgbed/202312112014946.png)

### 4.2.3挂号缴费界面

选择好医生后，系统会自动跳转到缴费界面，非社区病人挂号费为10元，社区病人挂号费为1元，用户可以选择立即缴费或稍后缴费，选择后跳转回到医生选择界面。

![image-20231211201759551](https://alist.sanyue.site/d/imgbed/202312112017732.png)

### 4.2.4费用清单

展示病人当前所有的费用清单，包含已缴费和未缴费的账单，立即缴费功能会**计算所有未缴费账单的总额**，然后跳转到缴费界面（与挂号缴费界面类似）。

![image-20231211202356072](https://alist.sanyue.site/d/imgbed/202312112023201.png)

### 4.2.5化验结果查询

展示病人当前所有的化验结果，展示化验**结果编号、化验名称、化验时间**等信息，用户可以选择想要查询的具体化验结果，点击`查看详情`进入该项化验结果的详情页。

![image-20231211202803468](https://alist.sanyue.site/d/imgbed/202312112028672.png)

### 4.2.6化验详情查看

展示某一个化验内容的具体结果，包含**项目编号，化验项目，化验结果，最小参考值，最大参考值，化验时间**等内容。其中，每一项的化验结果会根据最小参考值和最大参考值以及实际结果判断结果是否在正常范围内，并且直观地给出`正常`或`异常`的评估。

![image-20231211203034553](https://alist.sanyue.site/d/imgbed/202312112030674.png)

### 4.2.7诊断结果清单

展示病人所有的诊断结果，包含开具该诊断结果的**医生姓名，诊断时间**，点击`查看详情`后可以跳转到具体的诊断结果页面。

![image-20231211204302419](https://alist.sanyue.site/d/imgbed/202312112043543.png)

### 4.2.8诊断详情

展示具体的诊断详情，包括**诊断结果、编号、医生姓名、诊断时间**等内容。

![image-20231211205457002](https://alist.sanyue.site/d/imgbed/202312112054208.png)
